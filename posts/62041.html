<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Ethereum | ᑐ ᑌ ᑎ ᕮ</title><meta name="keywords" content="区块链"><meta name="author" content="Kevin Cheng"><meta name="copyright" content="Kevin Cheng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="区块链优点  去中心化：由于区块链是靠各个节点共同实现系统的维护和保证信息传递的真实性，基于分布式存储数据，而没有某个中心进行集中管理，因此某一个节点受到攻击和篡改不会影响整个网络的健康运作。 去信任化：任意两个节点之间建立连接不需要信任彼此的身份，双方之间进行数据交换无需互相信任的基础。由于网络中的所有节点都可以扮演“监督者”的身份，因此不用担心欺诈的问题。 可扩展：区块链是一种底层开源技术，在">
<meta property="og:type" content="article">
<meta property="og:title" content="Ethereum">
<meta property="og:url" content="https://kevinchengchn.eu.org/posts/62041">
<meta property="og:site_name" content="ᑐ ᑌ ᑎ ᕮ">
<meta property="og:description" content="区块链优点  去中心化：由于区块链是靠各个节点共同实现系统的维护和保证信息传递的真实性，基于分布式存储数据，而没有某个中心进行集中管理，因此某一个节点受到攻击和篡改不会影响整个网络的健康运作。 去信任化：任意两个节点之间建立连接不需要信任彼此的身份，双方之间进行数据交换无需互相信任的基础。由于网络中的所有节点都可以扮演“监督者”的身份，因此不用担心欺诈的问题。 可扩展：区块链是一种底层开源技术，在">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/04/04/660e93fe2c1f8.png">
<meta property="article:published_time" content="2018-08-26T00:00:00.000Z">
<meta property="article:modified_time" content="2029-03-21T00:00:00.000Z">
<meta property="article:author" content="Kevin Cheng">
<meta property="article:tag" content="区块链">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/04/04/660e93fe2c1f8.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://kevinchengchn.eu.org/posts/62041"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/manifest.json"/><meta name="msapplication-TileColor" content="#212121"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/siteicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/assets/siteicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/assets/siteicon/favicon-16x16.png"/><link rel="mask-icon" href="/assets/siteicon/safari-pinned-tab.svg" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/cdn/common/packages/fortawesome/fontawesome-free/6.5.1/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/cdn/common/packages/vue/2.6.11/vue%402.6.11" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"「温馨提示」本文距离上次更新已经过去","messageNext":"天，文章的部分内容可能已经过时，请注意甄别～"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Kevin Cheng","link":"链接: ","source":"来源: ᑐ ᑌ ᑎ ᕮ","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/cdn/common/packages/jquery/3.7.1/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2029-03-21 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="ᑐ ᑌ ᑎ ᕮ" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/03/29/66069d146e604.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="http://music.kevinchengchn.eu.org/"><i class="fa-fw fas fa-music"></i><span> Navidrome</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="http://alist.kevinchengchn.eu.org/"><i class="fa-fw fas fa-cloud"></i><span> Alist</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="http://img.kevinchengchn.eu.org/"><i class="fa-fw fas fa-images"></i><span> 图床</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/bangumi/"><i class="fa-fw fab fa-bilibili"></i><span> 动漫</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-film"></i><span> 影视</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book-open"></i><span> 图书</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/04/04/660e93fe2c1f8.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Kevin's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="http://music.kevinchengchn.eu.org/"><i class="fa-fw fas fa-music"></i><span> Navidrome</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="http://alist.kevinchengchn.eu.org/"><i class="fa-fw fas fa-cloud"></i><span> Alist</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="http://img.kevinchengchn.eu.org/"><i class="fa-fw fas fa-images"></i><span> 图床</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/bangumi/"><i class="fa-fw fab fa-bilibili"></i><span> 动漫</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-film"></i><span> 影视</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book-open"></i><span> 图书</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Ethereum</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2018-08-26T00:00:00.000Z" title="发表于 2018-08-26 00:00:00">2018-08-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2029-03-21T00:00:00.000Z" title="更新于 2029-03-21 00:00:00">2029-03-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%F0%9F%92%BB/">💻</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>24分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="区块链"><a href="#区块链" class="headerlink" title="区块链"></a>区块链</h1><p><strong>优点</strong></p>
<ul>
<li>去中心化：由于区块链是靠各个节点共同实现系统的维护和保证信息传递的真实性，基于分布式存储数据，而没有某个中心进行集中管理，因此某一个节点受到攻击和篡改不会影响整个网络的健康运作。</li>
<li>去信任化：任意两个节点之间建立连接不需要信任彼此的身份，双方之间进行数据交换无需互相信任的基础。由于网络中的所有节点都可以扮演“监督者”的身份，因此不用担心欺诈的问题。</li>
<li>可扩展：区块链是一种底层开源技术，在此基础上可以实现各类扩展和去中心化、去信任化的应用。</li>
<li>匿名化：数据交换的双方可以是匿名的，网络中的节点无需知道彼此的身份和个人信息即可进行数据交换。</li>
<li>安全可靠：由于任意节点之间的活动均受到全网的监督，并且数据库采用分布式存储。<br><strong>缺点</strong></li>
<li>以pow机制的区块链：需要引入大量公共资源参与到体系中来，如参与计算的节点数太少，则会面临 51%被攻击的可能性，严重威胁网络系统运作和价值。</li>
</ul>
<p><strong>名词</strong></p>
<ul>
<li>blockchain explorer: 一个作为虚拟币搜索引擎运行的Web应用程序，它允许您搜索地址，交易和块，并查看它们之间的关系和资金流动。</li>
<li>软分叉：由于整个区块链系统软件的升级，一部分矿工没有来得及升级，出现了遵从不同机制产生的分叉。当这部分矿工升级系统后，这个分叉就会消失</li>
<li>硬分叉：由于矿工之间出现分歧，一部分矿工决定采用不同的机制，产生出来的分叉是不会消失的<ul>
<li>事件：区块链圈里第一个有影响力的硬分叉应该是以太坊的分叉事件。以太坊上一个著名的项目The DAO由于其自身漏洞，导致黑客窃取了当时价值约6000万美元的以太币。2016年7月，以太坊开发团队通过修改以太坊软件的代码，在第1920000个区块强行把The DAO及其子DAO的所有资金全部转到一个特定的退款合约地址，从而“夺回”黑客所控制的DAO合约币。</li>
<li>在2017年8月1日，由ViaBTC领导的矿工团体创建一个比特币分叉——Bitcoin Cash(简称BCC或BCH)。这次分叉，让大量的比特币持有者凭空的增加了一种新的数字货币(BCH)。<br>硬分叉这种创造货币的方式和ICO非常类似，于是一个新的名词诞生了——IFO（Initial Fork Offerings）。矿工团队在创造分叉的同时，可以在分叉发生的区块中，利用自己的特权，分配一些货币给自己或其他人（直接写成CoinBase交易即可），然后再开放让所有人都可以参与挖矿。</li>
<li>由于一部分矿工并不认同这个修改，于是形成两条链，一条为以太坊（ETH），一条为以太坊经典（ETC），各自代表不同的社区共识以及价值观。当以太坊发生了这次硬分叉后，产生了两条区块链。由于这两条链在发生分叉之前的数据都是一样的，一个非常有意思的现象出现了：原本持有以太币（ETH）的人，发现自己除了持有原有的ETH外，又有了相同数量的ETC。</li>
</ul>
</li>
</ul>
<h1 id="以太坊"><a href="#以太坊" class="headerlink" title="以太坊"></a>以太坊</h1><blockquote>
<p>​    当我们想利用Ethereum区块链做交易（包括：转帐，智能合约互动时），我们就需要支付费用给区块链网络上的Miner矿工帮助确认交易纪录。这就像我们生活之中（你需要转钱给你在国外的朋友，你需要支付手续费给银行帮你做转帐。）在区块链上，每一个矿工都利用以太虚拟机执行相同的程序码和维护区块链网络。</p>
</blockquote>
<script type="math/tex; mode=display">
1 ether = 10^3 finney = 10^6 szabo = 10^9 gwei(shannon) = 10^{12} mwei = 10^{15} kwei = 10^{18} wei</script><script type="math/tex; mode=display">
1 tether = 10^3 gether = 10^6 mether = 10^9 kether = 10^{12} ether</script><ul>
<li>ADD这一个运算（将二个数值加上），EVM要求3 Gas费用</li>
<li>转帐要求21,000 GAS费用或以上</li>
</ul>
<p>Gas Price：愿意最多给多少Gas去完成这一个交易</p>
<p>Gas Limit：你愿意支付多少Ether给Ethereum区块链Miner矿工帮你执行这一笔交易</p>
<p><strong>交易费交易费用 = 实际用到天然气限价 \ 天然气价格</strong></p>
<p>Gas Limit：            90000</p>
<p>Gas Used By Txn：    21000</p>
<p>Gas Price：            0.00000002 Ether(20Gwei)</p>
<p>Actual Tx Cost/Fee：    0.00042 Ether(21000*0.00000002)</p>
<p><strong>Gas返还：</strong></p>
<ul>
<li>Gas充足，未消耗的Gas会返还</li>
<li>Gas不充足，则整个交易费用会被消耗掉，与智能合约的互动也会回滚数据</li>
</ul>
<h2 id="Solidity"><a href="#Solidity" class="headerlink" title="Solidity"></a>Solidity</h2><ul>
<li>from：        发送者地址(account1)</li>
<li><p>to：            接收账户地址或合约地址</p>
</li>
<li><p>data：        合约代码(用户编写的代码）</p>
</li>
<li><p>value：        转移的金额</p>
</li>
<li><p>Gas：        用来完成交易(执行合约)的Gas</p>
</li>
<li>GasPrice：    交易中愿意付出的Gas单价</li>
<li><p>nonce：        整数，用户发起的每笔交易都有唯一的编号，表示该交易是用户发起的第几笔交易</p>
</li>
<li><p>adress：     投票者地址，adress≈uint160</p>
</li>
<li>transfer：发送地址</li>
<li><p>balanceOf：查询余额</p>
</li>
<li><p>view：不修改合约数据</p>
</li>
<li>pure:存-几乎不消耗gas</li>
<li>event：事件：（存储消耗gas）</li>
</ul>
<h2 id="智能合约"><a href="#智能合约" class="headerlink" title="智能合约"></a>智能合约</h2><h5 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">部署在以太坊区块链上的代码是不可改变的，即无法重新部署一个新的合约到相同的地址上。 智能合约升级较为困难, 务必需要一次性将合约写&quot;完美&quot;(测试/验证要求极高)。</span><br><span class="line">hacking办法: </span><br><span class="line">部署一个拥有调用转发功能的智能合约 将收到的调用转发到另外一个包含逻辑功能的合约地址 当进行合约升级时，只需要部署一个新的合约并修改转发的目标地址，以指向新的合约。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="销毁"><a href="#销毁" class="headerlink" title="销毁"></a>销毁</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">contract owned&#123;</span><br><span class="line">	function owned() &#123; owner = msg.sender;&#125;</span><br><span class="line">	address owner;</span><br><span class="line">&#125;</span><br><span class="line">contract mortal is owned&#123;</span><br><span class="line">//此处的kill拥有owner的访问权，kill在所有的合约中都可用</span><br><span class="line">//所有的合约的构造器在mortal初始化时执行</span><br><span class="line">function kill() &#123;</span><br><span class="line">	selfdestruct(owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Solidity-1"><a href="#Solidity-1" class="headerlink" title="Solidity"></a>Solidity</h2><blockquote>
<p>在Solidity中constant、view、pure三个函数修饰词的作用是告诉编译器，函数不改变/不读取状态变量<br>在Solidity v4.17之前，只有constant，后来有人嫌constant这个词本身代表变量中的常量，不适合用来修饰函数，所以将constant拆成了view和pure。view的作用和constant一模一样，可以读取状态变量但是不能改；pure则更为严格，pure修饰的函数不能改也不能读状态变量，否则编译通不过。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装：</span><br><span class="line">	https://solidity.readthedocs.io/en/develop/installing-solidity.html</span><br></pre></td></tr></table></figure>
<h2 id="搭建私链"><a href="#搭建私链" class="headerlink" title="搭建私链"></a>搭建私链</h2><p><strong>准备环境</strong></p>
<ul>
<li>Golang环境配置</li>
<li>Git</li>
<li>以太坊客户端geth (<code>go get github.com/go-ethereum</code>)</li>
</ul>
<blockquote>
<p>缺少gcc环境则安装：<br><a target="_blank" rel="noopener" href="https://chocolatey.org/install">https://chocolatey.org/install</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tinyxiong/p/7918706.html">https://www.cnblogs.com/tinyxiong/p/7918706.html</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cmd：</span><br><span class="line">@&quot;%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command &quot;iex ((New-Object System.Net.WebClient).DownloadString(&#x27;https://chocolatey.org/install.ps1&#x27;))&quot; &amp;&amp; SET &quot;PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin&quot;</span><br><span class="line">PowerShell：</span><br><span class="line">Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString(&#x27;https://chocolatey.org/install.ps1&#x27;))</span><br></pre></td></tr></table></figure>
<ul>
<li>C:\Windows\system32&gt; choco install git    </li>
<li>C:\Windows\system32&gt; choco install golang</li>
<li>C:\Windows\system32&gt; choco install mingw</li>
<li>编译geth:  src\github.com\ethereum\go-ethereum&gt;    go install -v ./cmd/…</li>
</ul>
<h4 id="创始区块："><a href="#创始区块：" class="headerlink" title="创始区块："></a>创始区块：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">genesis.json（创世区块的配置文件）：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;config&quot;: &#123;</span><br><span class="line">        &quot;chainId&quot;: 0,</span><br><span class="line">        &quot;homesteadBlock&quot;: 0,</span><br><span class="line">        &quot;eip155Block&quot;: 0,</span><br><span class="line">        &quot;eip158Block&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">  &quot;alloc&quot;      : &#123;&#125;,</span><br><span class="line">  &quot;coinbase&quot;   : &quot;0x0000000000000000000000000000000000000000&quot;,</span><br><span class="line">  &quot;difficulty&quot; : &quot;0x20000&quot;,</span><br><span class="line">  &quot;extraData&quot;  : &quot;&quot;,</span><br><span class="line">  &quot;gasLimit&quot;   : &quot;0x2fefd8&quot;,</span><br><span class="line">  &quot;nonce&quot;      : &quot;0x0000000000000042&quot;,</span><br><span class="line">  &quot;mixhash&quot;    : &quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,</span><br><span class="line">  &quot;parentHash&quot; : &quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,</span><br><span class="line">  &quot;timestamp&quot;  : &quot;0x00&quot;</span><br><span class="line">&#125;</span><br><span class="line">参数解析：</span><br><span class="line">&#123;</span><br><span class="line">  nonce：为某个随机值</span><br><span class="line">  mixhash：与nonce配合用于挖矿，由上一个区块的一部分生成的hash。注意他和nonce的设置需要满足以太坊的Yellow paper, 4.3.4. Block Header 	Validity, (44)章节所描述的条件。</span><br><span class="line">  nonce：nonce就是一个64位随机数，用于挖矿，注意他和mixhash的设置需要满足以太坊的Yellow paper, 4.3.4. Block Header Validity, (44)章节所描述	的条件。</span><br><span class="line">  difficulty：设置当前区块的难度，如果难度过大，cpu挖矿就很难，这里设置较小难度</span><br><span class="line">  timestamp：设置创世块的时间戳</span><br><span class="line">  parentHash：上一个区块的hash值，因为是创世块，所以这个值是0</span><br><span class="line">  extraData	：附加信息，随便填，可以填你的个性信息</span><br><span class="line">  gasLimit：该值设置对GAS的消耗总量限制，用来限制区块能包含的交易信息总和，因为我们是私有链，所以填最大。</span><br><span class="line">  coinbase：矿工的账号，随便填</span><br><span class="line">  “alloc ”：&#123;</span><br><span class="line">    “0x0000000000000000000000000000000000000001”：&#123; “balance”： “111111111” &#125;，</span><br><span class="line">    “0x0000000000000000000000000000000000000002”：&#123; “balance”： “222222222” &#125;</span><br><span class="line">    &#125;	：为某些帐户提供资金  </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h4 id="初始化创世区块并启动私有链："><a href="#初始化创世区块并启动私有链：" class="headerlink" title="初始化创世区块并启动私有链："></a>初始化创世区块并启动私有链：</h4><ul>
<li>$ geth init ./genesis.json —datadir “./chain”                        （chain为创建的文件名）</li>
<li>geth —datadir “./chain” —nodiscover console 2&gt;&gt;eth_output.log        （输出到日志）</li>
<li>geth console 2&gt;&gt;eth_output.log                                      （C:\Users\Kevin\AppData\Roaming\Ethereum）<ul>
<li>datadir：        设置当前区块链网络数据存放的位置</li>
<li>console：        启动命令行模式，可以在Geth中执行命令</li>
<li>nodiscover：            私有链地址，不会被网上看到</li>
</ul>
</li>
</ul>
<h5 id="帐户的添加和查看："><a href="#帐户的添加和查看：" class="headerlink" title="帐户的添加和查看："></a>帐户的添加和查看：</h5><ul>
<li>创建帐户并初始化密码：<ul>
<li>$ personal.newAccount(“kevin”)</li>
</ul>
</li>
<li>查看账号：<ul>
<li>web3.eth.accounts</li>
</ul>
</li>
<li>给账户设置变量：<ul>
<li>acc0 = web3.eth.accounts[0]</li>
</ul>
</li>
<li>查看账户金额：<ul>
<li>web3.eth.getBalance(eth.accounts[0])</li>
</ul>
</li>
<li>查看格式化的以太币：<ul>
<li>web3.fromWei(web3.eth.getBalance(eth.accounts[0]))</li>
<li>web3.eth.getBalance(“账户名”)</li>
</ul>
</li>
</ul>
<h5 id="普通命令："><a href="#普通命令：" class="headerlink" title="普通命令："></a>普通命令：</h5><ul>
<li><p>miner.start()</p>
</li>
<li><p>miner.stop()</p>
</li>
<li><p>查看日志：</p>
<ul>
<li>tail -f eth_output.log</li>
</ul>
</li>
<li><p>查看区块数据：</p>
<ul>
<li>eth.blockNumber</li>
</ul>
</li>
</ul>
<h5 id="转账操作："><a href="#转账操作：" class="headerlink" title="转账操作："></a>转账操作：</h5><ul>
<li><p>web3.eth.sendTransaction({from:”转账人”,to:”收款人”,value:web3.toWei(10,”ether”)})</p>
</li>
<li><p>web3.eth.sendTransaction({from:acc0,to:acc1,value:web3.toWei(3,”ether”)})</p>
<p>当直接执行此方法时会抛出异常：<br>​    account is locked</p>
<pre><code>   at web3.js:3119:20
</code></pre><p>​    at web3.js:6023:15</p>
<pre><code>  at web3.js:4995:36
   at &lt;anonymous&gt;:1:1
</code></pre><p>​    抛出异常，显示帐号被锁<br>​<br>解锁转出账户：<br>​    personal.unlockAccount(“转出账户”,”密码”)<br>​    web3.personal.unlockAccount(acc0,”123456”)<br>其中第一个参数为转出账户，第二个参数为密码。也可以直填写第一个参数，然后通过命令行提示再输入密码。<br>但此时查看时会发现接收账户依旧为原来数值。此时需要执行挖矿命令，才会把转账真正完成。     </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; checkAllBalances()</span><br><span class="line"> 	eth.accounts[0]:  0xbe323cc4fde114269a9513a27d3e985f82b9e25d  balance: 1245 	ether</span><br><span class="line">	eth.accounts[1]:  0x3b0ec02b4193d14abdc9cc5b264b5e3f39624d70  balance: 0 ether</span><br><span class="line"> 	Total balance: 1245 ether</span><br><span class="line">undefined</span><br><span class="line">&gt; miner.start()</span><br><span class="line">null</span><br><span class="line">&gt; checkAllBalances()</span><br><span class="line">	eth.accounts[0]:  0xbe323cc4fde114269a9513a27d3e985f82b9e25d  balance: 1257 	ether</span><br><span class="line"> 	eth.accounts[1]:  0x3b0ec02b4193d14abdc9cc5b264b5e3f39624d70  balance: 3 ether</span><br><span class="line"> 	Total balance: 1260 ether</span><br><span class="line">undefined</span><br><span class="line">&gt; miner.stop()</span><br><span class="line">true</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="连接私链："><a href="#连接私链：" class="headerlink" title="连接私链："></a>连接私链：</h5><pre><code>$ geth --datadir chainData --rpcport=8545 console
exit
geth version
(https://github.com/chaozh/awesome-blockchain-cn)
</code></pre><h2 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">重入攻击（Re-Entrancy attack）</span><br><span class="line">未来区块hash eavedrop</span><br><span class="line">重锻攻击  ecdsa</span><br></pre></td></tr></table></figure>
<h5 id="女巫攻击-Sybil-Attack"><a href="#女巫攻击-Sybil-Attack" class="headerlink" title="女巫攻击(Sybil Attack)"></a>女巫攻击(Sybil Attack)</h5><p>为什么叫女巫攻击？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">根据Flora Rhea Schreiberie在1973年的小说《女巫》（Sybil）改编的同名电影，是一个化名Sybil Dorsett的女人心理治疗的故事。她被诊断为分离性身份认同障碍，兼具16种人格。</span><br></pre></td></tr></table></figure>
<p>什么是女巫攻击？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在对等网络中，节点通常具有多个身份标识，通过控制系统的大部分节点来消弱冗余备份的作用。女巫攻击是在P2P网络中，因为节点随时加入退出等原因，为了维持网络稳定，同一份数据通常需要备份到多个分布式节点上，这就是数据冗余机制。</span><br><span class="line">女巫攻击是攻击数据冗余机制的一种有效手段。如果网络中存在一个恶意节点，那么同一个恶意节点可以具有多重身份，就如电影了的女主角都可以分裂出16个身份，那么恶意节点比它还能分。这一分可好，原来需要备份到多个节点的数据被欺骗地备份到了同一个恶意节点（该恶意节点伪装成多重身份），这就是女巫攻击。</span><br><span class="line">攻击者可以向对等网络呈现多个身份，以便出现并充当多个不同的节点。因此，对手可能能够获得对网络的不成比例的控制水平，例如通过影响投票结果。</span><br></pre></td></tr></table></figure>
<p>怎么解决女巫攻击？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">一、工作量证明机制(POW)，即证明你是一个节点，别只说不练，而是要用计算能力证明，这样极大地增加了攻击的成本。</span><br><span class="line">二、身份认证（相对于PoW协议，女巫攻击是基于BFT拜占庭使用容错协议的Blockchain需要考虑的问题，需要采用相应的身份认证机制）</span><br><span class="line">认证机制分为二类：</span><br><span class="line"></span><br><span class="line">1）基于第三方的身份认证</span><br><span class="line">	每加入一个新的节点都需要与某一个可靠的第三方节点进行身份验证。</span><br><span class="line">2）纯分布式的身份认证</span><br><span class="line">	每加入一个新的节点都需要获得当前网络中所有可靠节点的认证，这种方法采用了随机密钥分发验证的公钥体制的认证方式，需要获得网络中大多数节点的认证才能加入该网络。</span><br></pre></td></tr></table></figure>
<p>通俗点？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">女巫攻击：分身诈骗术</span><br><span class="line">应对方法：</span><br><span class="line">1.干活 你即便分身千千万，唯有真心能干活。分心是虚幻的，没有力气，pow证明。</span><br><span class="line">2.发身份证 可靠第三方公安局给你发身份证，没有身份证都是分身妖怪。</span><br><span class="line">3.熟人社会 你迁户口到一个新的村子里，必须得到村子里，大部分人的认证，这就是中国传统社会的身份认证方法。群众的眼睛就是火眼金睛，照出一切妖魔鬼怪。</span><br></pre></td></tr></table></figure>
<h2 id="N-1、事件"><a href="#N-1、事件" class="headerlink" title="N+1、事件"></a>N+1、事件</h2><h4 id="编码规范问题"><a href="#编码规范问题" class="headerlink" title="编码规范问题"></a>编码规范问题</h4><h5 id="编译器版本"><a href="#编译器版本" class="headerlink" title="编译器版本"></a>编译器版本</h5><blockquote>
<p>合约代码中，应指定编译器版本。建议使用最新的编译器版本</p>
<p>老版本的编译器可能会导致各种已知的安全问题，<a target="_blank" rel="noopener" href="https://paper.seebug.org/631/#44-dividenddistributor">例如</a></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v0.4.23更新了一个编译器漏洞，在这个版本中如果同时使用了两种构造函数，即</span></span><br><span class="line">contract a &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">a</span>(<span class="params"></span>) public&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) public&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//会忽略其中的一个构造函数，该问题只影响v0.4.22</span></span><br></pre></td></tr></table></figure>
<h5 id="构造函数规范书写问题"><a href="#构造函数规范书写问题" class="headerlink" title="构造函数规范书写问题"></a>构造函数规范书写问题</h5><blockquote>
<p>Solidity0.4.22版本以前，编译器要求，构造函数名称应该和合约名称保持一致，如果构造函数名字和合约名字大小写不一致，该函数仍然会被当成普通函数，可以被任意用户调用。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://etherscan.io/address/0x2ef27bf41236bd859a95209e17a43fbd26851f92#code">MorphToken</a>的合约代码;</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0.4</span><span class="number">.22</span>版本之前，构造函数应和合约名称一致</span><br><span class="line"><span class="comment">//Owned()成为任何人都可以调用的普通函数</span></span><br><span class="line">contract <span class="title class_">Owned</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">Owned</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        	owner = msg.<span class="property">sender</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0.4</span><span class="number">.22</span>版本之后，引入了constructor关键字作为构造函数声明，但不需要<span class="keyword">function</span></span><br><span class="line">contract <span class="title class_">Owned</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/* 如果没有按照对应的写法，构造函数就会被编译成一个普通函数，可以被任意人调用，</span></span><br><span class="line"><span class="comment"> * 会导致owner权限被窃取等更严重的后果。</span></span><br><span class="line"><span class="comment"> */</span> </span><br></pre></td></tr></table></figure>
<h5 id="返回标准"><a href="#返回标准" class="headerlink" title="返回标准"></a>返回标准</h5><blockquote>
<p>遵循ERC20规范，要求transfer、approve函数应返回bool值，需要添加返回值代码</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address _to, uint256 _value</span>) public returns (bool success)</span><br><span class="line"><span class="comment">//而transferFrom返回结果应该和transfer返回结果一致。</span></span><br></pre></td></tr></table></figure>
<h5 id="事件标准"><a href="#事件标准" class="headerlink" title="事件标准"></a>事件标准</h5><blockquote>
<p>遵循ERC20规范，要求transfer、approve函数触发相应的事件</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address _spender, uint256 _value</span>) public returns (bool success)&#123;</span><br><span class="line">    allowance[msg.<span class="property">sender</span>][_spender] = _value;</span><br><span class="line">    emit <span class="title class_">Approval</span>(msg.<span class="property">sender</span>, _spender, _value)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h5 id="假充值漏洞"><a href="#假充值漏洞" class="headerlink" title="假充值漏洞"></a>假充值漏洞</h5><blockquote>
<p>ERC20标准规定，当余额不足时，合约应抛出错误使交易回滚(EVM获取到错误触发底层的revert指令回<br>滚交易)，否则会导致即使没有真正发生交易，但交易仍然成功，进而影响交易平台的判断结果，可能<br>导致假充值。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address _to,uint256 _amount</span>) returns (bool success) &#123;</span><br><span class="line">    <span class="title function_">initialize</span>(msg.<span class="property">sender</span>);</span><br><span class="line">    <span class="keyword">if</span> (balances[msg.<span class="property">sender</span>] &gt;=_amount &amp;&amp; _amount &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="title function_">initialize</span>(_to);</span><br><span class="line">        <span class="keyword">if</span> (balances[_to] + _amount &gt; balances[_to]) &#123;</span><br><span class="line">            balances[msg.<span class="property">sender</span>] -= _amount;</span><br><span class="line">            balances[_to] += _amount;</span><br><span class="line">            <span class="title class_">Transfer</span>(msg.<span class="property">sender</span>, _to, _amount);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//上述代码在判断余额时仅仅简单的返回false，TX还是成功的。</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>余额验证时使用require抛出错误</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 内部交易，只能在本合约内调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_transfer</span>(<span class="params">address _from, address _to, uint _value</span>) internal &#123;</span><br><span class="line">    <span class="comment">//防止交易到0x0地址。使用burn()代替</span></span><br><span class="line">    <span class="built_in">require</span>(_to != <span class="number">0x0</span>);</span><br><span class="line">    <span class="comment">//检查交易发起者余额是否充足</span></span><br><span class="line">    <span class="built_in">require</span>(balanceOf[_from] &gt;= _value);</span><br><span class="line">    <span class="comment">// 检查溢出</span></span><br><span class="line">    <span class="built_in">require</span>(balanceOf[_to] + _value &gt;= balanceOf[_to]);</span><br><span class="line">    <span class="comment">// 保存这个previousBalances(以前的余额)，为了之后执行的的断言</span></span><br><span class="line">    uint previousBalances = balanceOf[_from] + balanceOf[_to];</span><br><span class="line">    <span class="comment">// 减去交易发起者发送的额度</span></span><br><span class="line">    balanceOf[_from] -= _value;</span><br><span class="line">    <span class="comment">// 往收款方余额加入相同的额度</span></span><br><span class="line">    balanceOf[_to] += _value;</span><br><span class="line">    emit <span class="title class_">Transfer</span>(_from, _to, _value);</span><br><span class="line">    <span class="comment">// 断言是用来使用静态分析代码中的bug，断言不可能失败</span></span><br><span class="line">    <span class="title function_">assert</span>(balanceOf[_from] + balanceOf[_to] == previousBalances);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="设计缺陷问题"><a href="#设计缺陷问题" class="headerlink" title="设计缺陷问题"></a>设计缺陷问题</h4><h5 id="approve授权函数条件竞争"><a href="#approve授权函数条件竞争" class="headerlink" title="approve授权函数条件竞争"></a>approve授权函数条件竞争</h5><blockquote>
<p>在修改allowance前，应先修改为0，再修改为_value。</p>
<blockquote>
<p>这个漏洞的起因是由于底层矿工协议中为了鼓励矿工挖矿，矿工可以自己决定打包什么交易，为了收益更大，矿工一般会选择打包gas price更大的交易，而不会依赖交易顺序的前后。</p>
<blockquote>
<p>通过置0的方式，可以在一定程度上缓解条件竞争中产生的危害，合约管理人可以通过检查日志来判断是否有条件竞争情况的发生，这种修复方式更大的意义在于，提醒使用approve函数的用户，该函数的操作在一定程度上是不可逆的。</p>
</blockquote>
</blockquote>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address _spender, uint256 _value</span>) public returns (bool success)&#123;</span><br><span class="line">    allowance[msg.<span class="property">sender</span>][_spender] = _value;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">//上述代码就有可能导致条件竞争。</span></span><br><span class="line"><span class="comment">//应在approve中加入</span></span><br><span class="line"><span class="built_in">require</span>((_value == <span class="number">0</span>) || (allowance[msg.<span class="property">sender</span>][_spender] == <span class="number">0</span>));</span><br><span class="line"><span class="comment">//将allowance先改为0再改为对应数字</span></span><br></pre></td></tr></table></figure>
<h5 id="循环Dos问题"><a href="#循环Dos问题" class="headerlink" title="循环Dos问题"></a>循环Dos问题</h5><h5 id="2循环消耗问题"><a href="#2循环消耗问题" class="headerlink" title="2循环消耗问题"></a>2循环消耗问题</h5><blockquote>
<p>在合约中，不推荐使用太大次的循环</p>
<blockquote>
<p>在以太坊中，每一笔交易都会消耗一定量的gas，而实际消耗量是由交易的复杂度决定的，循环次数越大，交易的复杂度越高，当超过允许的最大gas消耗量时，会导致交易失败。</p>
</blockquote>
<p>事件：Pandemica庞氏游戏存在Gas超出漏洞，80余万资金遭冻结</p>
<blockquote>
<p> 庞氏游戏:譬如PoWH 3D、FOMO 3D等，因为基于区块链不可篡改、公开透明等特性，人们就算知道是“庞氏骗局”也会蜂拥而上。<a target="_blank" rel="noopener" href="https://etherscan.io/address/0xD8a1Db7AA1E0ec45E77B0108006dc311cD9D00e7#code">合约地址</a></p>
<blockquote>
<p>这个合约的机制非常简单：向合约充以太币，然后合约会不定时（受owner控制）向充值的用户赠送充值金额的3%作为奖励，回馈给用户。</p>
</blockquote>
</blockquote>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">contract <span class="title class_">Pandemica</span></span><br><span class="line">&#123;</span><br><span class="line">    struct _Tx &#123;</span><br><span class="line">        address txuser;</span><br><span class="line">        uint txvalue;</span><br><span class="line">    &#125;</span><br><span class="line">    _Tx[] public <span class="title class_">Tx</span>;</span><br><span class="line">    uint public counter;</span><br><span class="line">    address owner;</span><br><span class="line">    modifier onlyowner</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.<span class="property">sender</span> == owner)</span><br><span class="line">        _</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">Pandemica</span>(<span class="params"></span>) &#123;</span><br><span class="line">        owner = msg.<span class="property">sender</span>;    </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//当管理员充值的时候会触发Count函数</span></span><br><span class="line">    <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Sort</span>();</span><br><span class="line">        <span class="keyword">if</span> (msg.<span class="property">sender</span> == owner )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title class_">Count</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">Sort</span>(<span class="params"></span>) internal</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//用户充值，管理员抽走20%的手续费</span></span><br><span class="line">        uint feecounter;</span><br><span class="line">        feecounter+=msg.<span class="property">value</span>/<span class="number">5</span>;</span><br><span class="line">	    owner.<span class="title function_">send</span>(feecounter);</span><br><span class="line">	    feecounter=<span class="number">0</span>;</span><br><span class="line">        <span class="comment">//用户充值后使用Tx来存储用户和充值金额，使用counter来计充值数</span></span><br><span class="line">	   uint txcounter=<span class="title class_">Tx</span>.<span class="property">length</span>;     </span><br><span class="line">	   counter=<span class="title class_">Tx</span>.<span class="property">length</span>;</span><br><span class="line">	   <span class="title class_">Tx</span>.<span class="property">length</span>++;</span><br><span class="line">	   <span class="title class_">Tx</span>[txcounter].<span class="property">txuser</span>=msg.<span class="property">sender</span>;</span><br><span class="line">	   <span class="title class_">Tx</span>[txcounter].<span class="property">txvalue</span>=msg.<span class="property">value</span>;   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Count函数会给每个充值过的用户发放充值金额的3%作为奖励</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">Count</span>(<span class="params"></span>) onlyowner &#123;</span><br><span class="line">        <span class="keyword">while</span> (counter&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="title class_">Tx</span>[counter].<span class="property">txuser</span>.<span class="title function_">send</span>((<span class="title class_">Tx</span>[counter].<span class="property">txvalue</span>/<span class="number">100</span>)*<span class="number">3</span>);</span><br><span class="line">            counter-=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">/** counter变量在总体上是增量的，因为调用Count函数将counter变量归零后，下一次用户充值还会将充值		 * 数赋值给counter，所以 当counter的值达到某个阈值的时候，调用Count函数所需要的Gas会超过主网	       * 一个区块所能消耗的Gas的上限，这笔资金将冻结以太坊主网未来提升区块Gas上限的那一天才有可能解冻。</span></span><br><span class="line"><span class="comment">      * 以太坊每一个区块所能消耗的Gas是有上限的，在以太坊主网中，这个上限是8000000 Gas。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="编码安全问题"><a href="#编码安全问题" class="headerlink" title="编码安全问题"></a>编码安全问题</h4><h5 id="算数溢出"><a href="#算数溢出" class="headerlink" title="算数溢出"></a>算数溢出</h5><h5 id="BEC归零：-一行代码引发的64亿惨案"><a href="#BEC归零：-一行代码引发的64亿惨案" class="headerlink" title="BEC归零： 一行代码引发的64亿惨案"></a>BEC归零： 一行代码引发的64亿惨案</h5><blockquote>
<p>Beautychain（美蜜）代币名为BEC，2月23日在境外交易所OKEx上线后其开盘涨幅高达4000%，一度收获280亿美元市值。</p>
<p>2018年4月22日中午，BEC美蜜遭遇黑客的毁灭性攻击，天量BEC从<a target="_blank" rel="noopener" href="https://etherscan.io/tx/0xad89ff16fd1ebe3a0a7cf4ed282302c06626c1af33221ebe0d3a470aba4a660f">两个地址</a>转出，引发了市场抛售潮。</p>
<p>BEC合约代码仅299行，在257行位置出现算术溢出漏洞。未使用SafeMath方法，导致系统产生了整数溢出漏洞，黑客利用 in-the-wild方法，从BEC的程序中抓取到了漏洞，并发动了攻击。利用这个漏洞，黑客可以通过转账的手段生成合约中不存在的代币， 并将这些无中生有的数字货币转入正常账户</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://etherscan.io/address/0xc5d105e63711398af9bbff092d4b6769c82f793d#code">合约地址</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**	Function: batchTransfer(address[] _receivers, uint256 _value)</span></span><br><span class="line"><span class="comment"> *	MethodID: 0x83f12fec</span></span><br><span class="line"><span class="comment"> *	[0]: 0000000000000000000000000000000000000000000000000000000000000040</span></span><br><span class="line"><span class="comment"> *	[1]: 8000000000000000000000000000000000000000000000000000000000000000  _value的值</span></span><br><span class="line"><span class="comment"> *	[2]: 0000000000000000000000000000000000000000000000000000000000000002</span></span><br><span class="line"><span class="comment"> *	[3]: 000000000000000000000000b4d30cac5124b46c2df0cf3e3e1be05f42119033  _receivers值</span></span><br><span class="line"><span class="comment"> *	[4]: 0000000000000000000000000e823ffe018727585eaf5bc769fa80472f76c3d7  _receivers值</span></span><br><span class="line"><span class="comment"> *	（上面数值为16进制，64位数）</span></span><br><span class="line"><span class="comment"> *	batchTransfer批量转账函数</span></span><br><span class="line"><span class="comment"> *	_receivers（代币接收者）该值包含多个地址(hacker钱包地址）：</span></span><br><span class="line"><span class="comment"> *			To：		0x0e823ffe018727585eaf5bc769fa80472f76c3d7</span></span><br><span class="line"><span class="comment"> *			To：		0xb4d30cac5124b46c2df0cf3e3e1be05f42119033</span></span><br><span class="line"><span class="comment"> *			From：	0x09a34e01fbaa49f27b0b129d3c5e6e21ed5fe93c</span></span><br><span class="line"><span class="comment"> *	_value（转账金额）</span></span><br><span class="line"><span class="comment"> *	amount（发送的代币总金额）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">batchTransfer</span>(<span class="params">address[] _receivers, uint256 _value</span>) public whenNotPaused returns (bool) &#123;</span><br><span class="line">    <span class="comment">//批量转账的地址数量</span></span><br><span class="line">    uint cnt = _receivers.<span class="property">length</span>;</span><br><span class="line">    <span class="comment">/*	发送的代币总金额 = 地址数量 * 发送的金额</span></span><br><span class="line"><span class="comment">     *	amount、_value为uint256,其最大数为： 115792089237316195423570985008687907853269984665640564039457584007913129639935</span></span><br><span class="line"><span class="comment">     *	_value = 0x8000000000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line"><span class="comment">     *	转换成10进制为：57896044618658097711785492504343953926634992332820282019728792003956564819968</span></span><br><span class="line"><span class="comment">     *	_value*2 = </span></span><br><span class="line"><span class="comment">115792089237316195423570985008687907853269984665640564039457584007913129639936</span></span><br><span class="line"><span class="comment">     *	uintx 类型的取值范围是 0 到 2的x次方 -1</span></span><br><span class="line"><span class="comment">     *	以uint8为例：最大值为255，255+1=0，0-1=255；</span></span><br><span class="line"><span class="comment">     *	此时amount = 0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    uint256 amount = <span class="title function_">uint256</span>(cnt) * _value;</span><br><span class="line">    <span class="built_in">require</span>(cnt &gt; <span class="number">0</span> &amp;&amp; cnt &lt;= <span class="number">20</span>);</span><br><span class="line">    <span class="built_in">require</span>(_value &gt; <span class="number">0</span> &amp;&amp; balances[msg.<span class="property">sender</span>] &gt;= amount);</span><br><span class="line">	<span class="comment">//当前账户余额 - amount</span></span><br><span class="line">    balances[msg.<span class="property">sender</span>] = balances[msg.<span class="property">sender</span>].<span class="title function_">sub</span>(amount);</span><br><span class="line">    <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; cnt; i++) &#123;</span><br><span class="line">        balances[_receivers[i]] = balances[_receivers[i]].<span class="title function_">add</span>(_value);</span><br><span class="line">    <span class="comment">//保存交易记录   </span></span><br><span class="line">        <span class="title class_">Transfer</span>(msg.<span class="property">sender</span>, _receivers[i], _value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">验证：</span><br><span class="line"></span><br><span class="line">package main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line">func <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> a uint8=<span class="number">128</span></span><br><span class="line">	<span class="keyword">var</span> amount uint8 = a*<span class="number">2</span></span><br><span class="line">	fmt.<span class="title class_">Println</span>(amount)</span><br><span class="line">&#125;</span><br><span class="line">&gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.25</span>;</span><br><span class="line">contract <span class="title class_">MyContract</span> &#123;</span><br><span class="line">    uint256 public a;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">uint256 b</span>) public &#123;</span><br><span class="line">        a = b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">update</span>(<span class="params">uint256 c</span>) public &#123;</span><br><span class="line">        a = c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&gt; c = <span class="number">115792089237316195423570985008687907853269984665640564039457584007913129639936</span></span><br></pre></td></tr></table></figure>
<h5 id="Hexagon溢出漏洞"><a href="#Hexagon溢出漏洞" class="headerlink" title="Hexagon溢出漏洞"></a><a target="_blank" rel="noopener" href="https://etherscan.io/address/0xB5335e24d0aB29C190AB8C2B459238Da1153cEBA">Hexagon</a>溢出漏洞</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Hexagon</span> &#123;</span><br><span class="line">  <span class="comment">/* Main information */</span></span><br><span class="line">  string public constant name = <span class="string">&quot;Hexagon&quot;</span>;</span><br><span class="line">  string public constant symbol = <span class="string">&quot;HXG&quot;</span>;</span><br><span class="line">  uint8 public constant decimals = <span class="number">4</span>;</span><br><span class="line">  uint8 public constant burnPerTransaction = <span class="number">2</span>;</span><br><span class="line">  uint256 public constant initialSupply = <span class="number">420000000000000</span>;</span><br><span class="line">  uint256 public currentSupply = initialSupply;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Create array with balances */</span></span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balanceOf;</span><br><span class="line">  <span class="comment">/* Create array with allowance */</span></span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Constructor */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">Hexagon</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    <span class="comment">/* Give creator all initial supply of tokens */</span></span><br><span class="line">    balanceOf[msg.<span class="property">sender</span>] = initialSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* PUBLIC */</span></span><br><span class="line">  <span class="comment">/* Send tokens */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address _to, uint256 _value</span>) public returns (bool success) &#123;</span><br><span class="line">    <span class="title function_">_transfer</span>(msg.<span class="property">sender</span>, _to, _value);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Return current supply */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">totalSupply</span>(<span class="params"></span>) public constant returns (uint) &#123;</span><br><span class="line">    <span class="keyword">return</span> currentSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Burn tokens */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">burn</span>(<span class="params">uint256 _value</span>) public returns (bool success) &#123;</span><br><span class="line">    <span class="comment">/* Check if the sender has enough */</span></span><br><span class="line">    <span class="built_in">require</span>(balanceOf[msg.<span class="property">sender</span>] &gt;= _value);</span><br><span class="line">    <span class="comment">/* Subtract from the sender */</span></span><br><span class="line">    balanceOf[msg.<span class="property">sender</span>] -= _value;</span><br><span class="line">    <span class="comment">/* Send to the black hole */</span></span><br><span class="line">    balanceOf[<span class="number">0x0</span>] += _value;</span><br><span class="line">    <span class="comment">/* Update current supply */</span></span><br><span class="line">    currentSupply -= _value;</span><br><span class="line">    <span class="comment">/* Notify network */</span></span><br><span class="line">    <span class="title class_">Burn</span>(msg.<span class="property">sender</span>, _value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Allow someone to spend on your behalf */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address _spender, uint256 _value</span>) public returns (bool success) &#123;</span><br><span class="line">    <span class="comment">/* Check if the sender has already  */</span></span><br><span class="line">    <span class="built_in">require</span>(_value == <span class="number">0</span> || allowance[msg.<span class="property">sender</span>][_spender] == <span class="number">0</span>);</span><br><span class="line">    <span class="comment">/* Add to allowance  */</span></span><br><span class="line">    allowance[msg.<span class="property">sender</span>][_spender] = _value;</span><br><span class="line">    <span class="comment">/* Notify network */</span></span><br><span class="line">    <span class="title class_">Approval</span>(msg.<span class="property">sender</span>, _spender, _value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Transfer tokens from allowance */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">transferFrom</span>(<span class="params">address _from, address _to, uint256 _value</span>) public returns (bool success) &#123;</span><br><span class="line">    <span class="comment">/* Prevent transfer of not allowed tokens */</span></span><br><span class="line">    <span class="built_in">require</span>(allowance[_from][msg.<span class="property">sender</span>] &gt;= _value);</span><br><span class="line">    <span class="comment">/* Remove tokens from allowance */</span></span><br><span class="line">    allowance[_from][msg.<span class="property">sender</span>] -= _value;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">_transfer</span>(_from, _to, _value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* INTERNAL */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">_transfer</span>(<span class="params">address _from, address _to, uint _value</span>) internal &#123;</span><br><span class="line">    <span class="comment">/* 防止交易到0x0地址。使用burn()代替  */</span></span><br><span class="line">    <span class="built_in">require</span> (_to != <span class="number">0x0</span>);</span><br><span class="line">    <span class="comment">/* 检查交易发起者余额是否充足 */</span></span><br><span class="line">    <span class="built_in">require</span> (balanceOf[_from] &gt;= _value + burnPerTransaction);</span><br><span class="line">    <span class="comment">/* 检查溢出 */</span></span><br><span class="line">    <span class="built_in">require</span> (balanceOf[_to] + _value &gt; balanceOf[_to]);</span><br><span class="line">    <span class="comment">/* 减去发送方的值 */</span></span><br><span class="line">    balanceOf[_from] -= _value + burnPerTransaction;</span><br><span class="line">    <span class="comment">/* 加上收件人相同的值 */</span></span><br><span class="line">    balanceOf[_to] += _value;</span><br><span class="line">    <span class="comment">/* 申请交易手续费 */</span></span><br><span class="line">    balanceOf[<span class="number">0x0</span>] += burnPerTransaction;</span><br><span class="line">    <span class="comment">/* 更新当前的供应 */</span></span><br><span class="line">    currentSupply -= burnPerTransaction;</span><br><span class="line">    <span class="comment">/* 通知网络 */</span></span><br><span class="line">    <span class="title class_">Burn</span>(_from, burnPerTransaction);</span><br><span class="line">    <span class="comment">/* 通知网络 */</span></span><br><span class="line">    <span class="title class_">Transfer</span>(_from, _to, _value);</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">/** 漏洞</span></span><br><span class="line"><span class="comment">     *  合约中 burnPerTransaction = 2，当转账_value=</span></span><br><span class="line"><span class="comment">     *  0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe</span></span><br><span class="line"><span class="comment">     *  _value + burnPerTransaction =0 ，即可成功攻击，为balanceOf[_to]增加大量代币</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Events */</span></span><br><span class="line">  event <span class="title class_">Transfer</span>(address indexed <span class="keyword">from</span>, address indexed to, uint256 value);</span><br><span class="line">  event <span class="title class_">Burn</span>(address indexed <span class="keyword">from</span>, uint256 value);</span><br><span class="line">  event <span class="title class_">Approval</span>(address indexed _owner, address indexed _spender, uint256 _value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="铸币烧币溢出问题"><a href="#铸币烧币溢出问题" class="headerlink" title="铸币烧币溢出问题"></a>铸币烧币溢出问题</h5><blockquote>
<p>铸币函数中，应对totalSupply设置上限，避免因为算术溢出等漏洞导致恶意铸币增发</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">function TokenERC20(</span><br><span class="line">    uint256 initialSupply,</span><br><span class="line">    string tokenName,</span><br><span class="line">    string tokenSymbol</span><br><span class="line">) public &#123;</span><br><span class="line">    totalSupply = initialSupply * 10 ** uint256(decimals);  </span><br><span class="line">    balanceOf[msg.sender] = totalSupply;                </span><br><span class="line">    name = tokenName;                                   </span><br><span class="line">    symbol = tokenSymbol;                               </span><br><span class="line">&#125;</span><br><span class="line">上述代码中就未对totalSupply做限制，可能导致指数算数上溢</span><br><span class="line">contract OPL &#123;</span><br><span class="line">    // Public variables</span><br><span class="line">    string public name;</span><br><span class="line">    string public symbol;</span><br><span class="line">    uint8 public decimals = 18; // 18 decimals</span><br><span class="line">    bool public adminVer = false;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 public totalSupply;</span><br><span class="line">    function OPL() public &#123;</span><br><span class="line">        totalSupply = 210000000 * 10 ** uint256(decimals);      </span><br><span class="line">        ...                                 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="N-2、防护"><a href="#N-2、防护" class="headerlink" title="N+2、防护"></a>N+2、防护</h2><h5 id="SafeMath"><a href="#SafeMath" class="headerlink" title="SafeMath"></a>SafeMath</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.25</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">SafeMath</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev</span> Math operations with safety checks that throw on error</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev</span> source: https://github.com/OpenZeppelin/openzeppelin-solidity/blob/v1.6.0/contracts/math/SafeMath.sol</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@notice</span> Basic implementation of SafeMath Contract from OpenZeppelin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">library <span class="title class_">SafeMath</span> &#123;</span><br><span class="line">    <span class="comment">/** 乘法</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@dev</span> Multiplies two numbers, throws on overflow.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mul</span>(<span class="params">uint256 a, uint256 b</span>) internal pure returns (uint256) &#123;</span><br><span class="line">        <span class="comment">//任何数乘0，结果都是0</span></span><br><span class="line">        <span class="keyword">if</span> (a == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        uint256 c = a * b;</span><br><span class="line">        <span class="title function_">assert</span>(c / a == b); <span class="comment">//逆向检查，如果c溢出将终止执行；（也就是括号内为假，程序终止）。</span></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 除法</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@dev</span> Integer division of two numbers, truncating the quotient.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">div</span>(<span class="params">uint256 a, uint256 b</span>) internal pure returns (uint256) &#123;</span><br><span class="line">        uint256 c = a / b;  <span class="comment">//由于整数除以整数不会溢出，不需要逆向检查</span></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 减法</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@dev</span> Substracts two numbers, throws on overflow (i.e. if subtrahend is greater than minuend).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sub</span>(<span class="params">uint256 a, uint256 b</span>) internal pure returns (uint256) &#123;</span><br><span class="line">        <span class="title function_">assert</span>(b &lt;= a);<span class="comment">//如果b&gt;a,b-a是负数，则溢出</span></span><br><span class="line">        <span class="keyword">return</span> a-b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 加法</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@dev</span> Adds two numbers, throws on overflow.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">uint256 a,uint256 b</span>) internal pure returns (uint256) &#123;</span><br><span class="line">        uint256 c = a + b;</span><br><span class="line">        <span class="title function_">assert</span>(c &gt;= a);<span class="comment">//如果a+b结果更小了，则说明有溢出</span></span><br><span class="line">        <span class="comment">//有人可能会问，为啥不检查c=&gt;b?</span></span><br><span class="line">        <span class="comment">//因为如果c&lt;a,则说明a+b结果溢出，也就是b+a会溢出，也就是b越加a越小，即c&lt;b.</span></span><br><span class="line">        rerurn c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">调用<span class="title class_">SafeMath</span>库的方法如下：</span><br><span class="line">contract <span class="title class_">MyContract</span> &#123;</span><br><span class="line">    using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>Ethereum</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://kevinchengchn.eu.org/posts/62041">https://kevinchengchn.eu.org/posts/62041</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>Kevin Cheng</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2018-08-26</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2029-03-21</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/">区块链</a></div><div class="post_share"><div class="social-share" data-image="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/04/04/660e93fe2c1f8.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/64360"><img class="prev-cover" src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/04/04/660e93f1a74e5.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Ubuntu</div></div></a></div><div class="next-post pull-right"><a href="/posts/25247"><img class="next-cover" src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/04/04/660e93f94724e.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Git</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/03/29/66069d146e604.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Kevin Cheng</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8C%BA%E5%9D%97%E9%93%BE"><span class="toc-number">1.</span> <span class="toc-text">区块链</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A5%E5%A4%AA%E5%9D%8A"><span class="toc-number">2.</span> <span class="toc-text">以太坊</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Solidity"><span class="toc-number">2.1.</span> <span class="toc-text">Solidity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6"><span class="toc-number">2.2.</span> <span class="toc-text">智能合约</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7"><span class="toc-number">2.2.0.0.1.</span> <span class="toc-text">升级</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%94%80%E6%AF%81"><span class="toc-number">2.2.0.0.2.</span> <span class="toc-text">销毁</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solidity-1"><span class="toc-number">2.3.</span> <span class="toc-text">Solidity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E7%A7%81%E9%93%BE"><span class="toc-number">2.4.</span> <span class="toc-text">搭建私链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%A7%8B%E5%8C%BA%E5%9D%97%EF%BC%9A"><span class="toc-number">2.4.0.1.</span> <span class="toc-text">创始区块：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%9B%E4%B8%96%E5%8C%BA%E5%9D%97%E5%B9%B6%E5%90%AF%E5%8A%A8%E7%A7%81%E6%9C%89%E9%93%BE%EF%BC%9A"><span class="toc-number">2.4.0.2.</span> <span class="toc-text">初始化创世区块并启动私有链：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%90%E6%88%B7%E7%9A%84%E6%B7%BB%E5%8A%A0%E5%92%8C%E6%9F%A5%E7%9C%8B%EF%BC%9A"><span class="toc-number">2.4.0.2.1.</span> <span class="toc-text">帐户的添加和查看：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E5%91%BD%E4%BB%A4%EF%BC%9A"><span class="toc-number">2.4.0.2.2.</span> <span class="toc-text">普通命令：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BD%AC%E8%B4%A6%E6%93%8D%E4%BD%9C%EF%BC%9A"><span class="toc-number">2.4.0.2.3.</span> <span class="toc-text">转账操作：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E7%A7%81%E9%93%BE%EF%BC%9A"><span class="toc-number">2.4.0.2.4.</span> <span class="toc-text">连接私链：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB"><span class="toc-number">2.5.</span> <span class="toc-text">攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A5%B3%E5%B7%AB%E6%94%BB%E5%87%BB-Sybil-Attack"><span class="toc-number">2.5.0.0.1.</span> <span class="toc-text">女巫攻击(Sybil Attack)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#N-1%E3%80%81%E4%BA%8B%E4%BB%B6"><span class="toc-number">2.6.</span> <span class="toc-text">N+1、事件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%E9%97%AE%E9%A2%98"><span class="toc-number">2.6.0.1.</span> <span class="toc-text">编码规范问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%99%A8%E7%89%88%E6%9C%AC"><span class="toc-number">2.6.0.1.1.</span> <span class="toc-text">编译器版本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E8%A7%84%E8%8C%83%E4%B9%A6%E5%86%99%E9%97%AE%E9%A2%98"><span class="toc-number">2.6.0.1.2.</span> <span class="toc-text">构造函数规范书写问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E6%A0%87%E5%87%86"><span class="toc-number">2.6.0.1.3.</span> <span class="toc-text">返回标准</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E6%A0%87%E5%87%86"><span class="toc-number">2.6.0.1.4.</span> <span class="toc-text">事件标准</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%87%E5%85%85%E5%80%BC%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.6.0.1.5.</span> <span class="toc-text">假充值漏洞</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E7%BC%BA%E9%99%B7%E9%97%AE%E9%A2%98"><span class="toc-number">2.6.0.2.</span> <span class="toc-text">设计缺陷问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#approve%E6%8E%88%E6%9D%83%E5%87%BD%E6%95%B0%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89"><span class="toc-number">2.6.0.2.1.</span> <span class="toc-text">approve授权函数条件竞争</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AFDos%E9%97%AE%E9%A2%98"><span class="toc-number">2.6.0.2.2.</span> <span class="toc-text">循环Dos问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E5%BE%AA%E7%8E%AF%E6%B6%88%E8%80%97%E9%97%AE%E9%A2%98"><span class="toc-number">2.6.0.2.3.</span> <span class="toc-text">2循环消耗问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="toc-number">2.6.0.3.</span> <span class="toc-text">编码安全问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%97%E6%95%B0%E6%BA%A2%E5%87%BA"><span class="toc-number">2.6.0.3.1.</span> <span class="toc-text">算数溢出</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BEC%E5%BD%92%E9%9B%B6%EF%BC%9A-%E4%B8%80%E8%A1%8C%E4%BB%A3%E7%A0%81%E5%BC%95%E5%8F%91%E7%9A%8464%E4%BA%BF%E6%83%A8%E6%A1%88"><span class="toc-number">2.6.0.3.2.</span> <span class="toc-text">BEC归零： 一行代码引发的64亿惨案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Hexagon%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.6.0.3.3.</span> <span class="toc-text">Hexagon溢出漏洞</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%93%B8%E5%B8%81%E7%83%A7%E5%B8%81%E6%BA%A2%E5%87%BA%E9%97%AE%E9%A2%98"><span class="toc-number">2.6.0.3.4.</span> <span class="toc-text">铸币烧币溢出问题</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#N-2%E3%80%81%E9%98%B2%E6%8A%A4"><span class="toc-number">2.7.</span> <span class="toc-text">N+2、防护</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#SafeMath"><span class="toc-number">2.7.0.0.1.</span> <span class="toc-text">SafeMath</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/52571" title="Blog Update History"><img src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/04/04/660e93fa0cac1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Blog Update History"/></a><div class="content"><a class="title" href="/posts/52571" title="Blog Update History">Blog Update History</a><time datetime="2024-03-31T20:22:59.000Z" title="发表于 2024-03-31 20:22:59">2024-03-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/55764" title="玩坏『Github Contributions』"><img src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/03/30/6607cf8dd58b7.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="玩坏『Github Contributions』"/></a><div class="content"><a class="title" href="/posts/55764" title="玩坏『Github Contributions』">玩坏『Github Contributions』</a><time datetime="2024-03-30T19:00:00.000Z" title="发表于 2024-03-30 19:00:00">2024-03-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/31566" title="电影院规格"><img src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/02/26/65dc75f1151ad.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="电影院规格"/></a><div class="content"><a class="title" href="/posts/31566" title="电影院规格">电影院规格</a><time datetime="2024-02-26T19:27:08.000Z" title="发表于 2024-02-26 19:27:08">2024-02-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3258" title="健身"><img src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/03/31/66096fa56c00d.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="健身"/></a><div class="content"><a class="title" href="/posts/3258" title="健身">健身</a><time datetime="2024-02-20T19:52:00.000Z" title="发表于 2024-02-20 19:52:00">2024-02-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/38170" title="程序员拥有一台服务器可以做哪些很酷的事情？"><img src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/2024/04/02/660adbc4acf88.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="程序员拥有一台服务器可以做哪些很酷的事情？"/></a><div class="content"><a class="title" href="/posts/38170" title="程序员拥有一台服务器可以做哪些很酷的事情？">程序员拥有一台服务器可以做哪些很酷的事情？</a><time datetime="2023-09-23T00:00:00.000Z" title="发表于 2023-09-23 00:00:00">2023-09-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Kevin Cheng</div><div id="workboard"></div><script async="async" src="/js/custom/runtime.js"></script><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo"/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender"/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&amp;logo=Codio"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub"/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris"/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/cdn/common/packages/vue/2.6.11/vue%402.6.11"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);</script></div><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    loader: {
      source: {
        '[tex]/amsCd': '[tex]/amscd'
      }
    },
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        addClass: [200,() => {
          document.querySelectorAll('mjx-container:not([display=\'true\']').forEach( node => {
            const target = node.parentNode
            if (!target.classList.contains('has-jax')) {
              target.classList.add('mathjax-overflow')
            }
          })
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><script defer src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/cdn/common/packages/jquery/3.7.1/dist/jquery.min.js"></script><script defer src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/cdn/common/packages/hexo-theme-volantis/5.8.0/source/js/issues.min.js"></script><script async src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/cdn/common/font/ali/butterfly/font_2522999_yjo9dtaqaw.js"></script><script src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/cdn/common/packages/butterfly-extsrc/1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/cdn/common/packages/butterfly-extsrc/1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="ᑐ,ᑌ,ᑎ,ᕮ" data-fontsize="15px" data-random="false" async="async"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1s');
    arr[i].setAttribute('data-wow-delay', '0');
    arr[i].setAttribute('data-wow-offset', '0');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer="defer" src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/cdn/common/packages/graingert/wow/1.3.0/dist/wow.min.js"></script><script defer="defer" src="/js/custom/wow_init.js"></script><div class="app-refresh" id="app-refresh" style="position: fixed;top: -2.2rem;left: 0;right: 0;z-index: 99999;padding: 0 1rem;font-size: 15px;height: 2.2rem;transition: all 0.3s ease;"><div class="app-refresh-wrap" style=" display: flex;color: #fff;height: 100%;align-items: center;justify-content: center;"><label>✨ Spice 👉</label><a href="javascript:void(0)" onclick="location.reload()"><span style="color: #fff;text-decoration: underline;cursor: pointer;">🍭 Melange</span></a></div></div><script>if ('serviceWorker' in navigator) {
  if (navigator.serviceWorker.controller) {
    navigator.serviceWorker.addEventListener('controllerchange', function() {
    showNotification()
  })
}
window.addEventListener('load', function() {
  navigator.serviceWorker.register('/sw.js')
  })
}
function showNotification() {
  if (GLOBAL_CONFIG.Snackbar) {
    var snackbarBg = document.documentElement.getAttribute('data-theme') === 'light' ?
    GLOBAL_CONFIG.Snackbar.bgLight :
    GLOBAL_CONFIG.Snackbar.bgDark
    var snackbarPos = GLOBAL_CONFIG.Snackbar.position
      Snackbar.show({
        text: '✨ Spice 👉',
        backgroundColor: snackbarBg,
        duration: 500000,
        pos: snackbarPos,
        actionText: '🍭 Melange',
        actionTextColor: '#fff',
        onActionClick: function(e) {
        location.reload()
        },
      })
    } else {
    var showBg = document.documentElement.getAttribute('data-theme') === 'light' ?
    '#49b1f5' :
    '#1f1f1f'
    var cssText = `top: 0; background: ${showBg};`
    document.getElementById('app-refresh').style.cssText = cssText
  }
}</script><script async data-pjax src="https://img-kevinchengchn.oss-cn-shanghai.aliyuncs.com/cdn/common/packages/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>